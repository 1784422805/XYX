<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>沉浸式游戏体验</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        .game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
        }
        
        .game-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1010;
            transition: opacity 0.5s;
        }
        
        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .welcome-message h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #3498db, #2ecc71, #f1c40f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 2s infinite;
        }
        
        .welcome-message p {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        .progress-container {
            width: 80%;
            max-width: 400px;
            margin: 20px 0;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #444;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s;
            border-radius: 10px;
        }
        
        .floating-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1020;
            transition: opacity 0.3s;
            opacity: 1;
        }
        
        .floating-controls.hide {
            opacity: 0;
            pointer-events: none;
        }
        
        .floating-controls button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        
        .floating-controls button:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        .error-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            padding: 20px;
            text-align: center;
        }
        
        .error-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            backdrop-filter: blur(10px);
            animation: slideUp 0.8s ease-out;
        }
        
        .error-icon {
            font-size: 5rem;
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #e74c3c;
        }
        
        .error-message {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .auth-btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .auth-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .auth-btn i {
            margin-right: 10px;
        }
        
        footer {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .fullscreen-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .fullscreen-prompt.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .fullscreen-prompt-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: white;
        }
        
        .fullscreen-prompt h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #f1c40f;
        }
        
        .fullscreen-prompt p {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .fullscreen-tutorial {
            margin: 20px 0;
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
        
        .fullscreen-tutorial ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .fullscreen-tutorial li {
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .fullscreen-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .fullscreen-btn {
            padding: 12px 25px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .fullscreen-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }
        
        .fullscreen-btn.apple {
            background: #007aff;
        }
        
        .fullscreen-btn.apple:hover {
            background: #0062cc;
        }
        
        /* 教程弹窗样式 */
        .tutorial-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .tutorial-prompt.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .tutorial-prompt-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: left;
            backdrop-filter: blur(10px);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .tutorial-prompt h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #f1c40f;
            text-align: center;
        }
        
        .tutorial-prompt h4 {
            font-size: 1.3rem;
            margin: 15px 0 10px 0;
            color: #3498db;
        }
        
        .tutorial-prompt ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .tutorial-prompt li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .tutorial-prompt .highlight {
            background: rgba(255, 215, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #f1c40f;
            margin: 15px 0;
        }
        
        /* 苹果设备提示 */
        .apple-tip {
            background: rgba(0, 122, 255, 0.2);
            border: 1px solid #007aff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            animation: pulseBorder 2s infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulseBorder {
            0% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 122, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); }
        }
        
        @media (max-width: 768px) {
            .welcome-message h2 {
                font-size: 2rem;
            }
            
            .error-title {
                font-size: 2rem;
            }
            
            .error-message {
                font-size: 1rem;
            }
            
            .auth-btn {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            
            .floating-controls {
                top: 10px;
                right: 10px;
            }
            
            .floating-controls button {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .fullscreen-prompt h3 {
                font-size: 1.5rem;
            }
            
            .fullscreen-prompt-content {
                padding: 20px;
            }
            
            .tutorial-prompt h3 {
                font-size: 1.5rem;
            }
            
            .tutorial-prompt-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 游戏容器 -->
    <div class="game-container" id="gameContainer">
        <iframe class="game-frame" id="gameFrame" allowfullscreen></iframe>
        <div class="game-overlay" id="gameOverlay">
            <div class="welcome-message">
                <h2 id="gameWelcomeUser">正在加载游戏...</h2>
                <p id="gameLoadingStatus">请稍候，正在准备您的游戏体验</p>
            </div>
            
            <div class="spinner"></div>
            
            <div class="progress-container">
                <div class="progress-text">
                    <span>加载进度</span>
                    <span id="gameProgressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="gameProgressBar"></div>
                </div>
            </div>
            
            <!-- 苹果设备提示 -->
            <div class="apple-tip" id="appleTip" style="display: none;">
                <i class="fab fa-apple"></i> 苹果设备提示：请将本页添加到主屏幕以获得最佳体验和存档功能
            </div>
        </div>
    </div>
    
    <!-- 错误提示容器 -->
    <div class="error-container" id="errorContainer">
        <div class="error-content">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="error-title">非法访问</h2>
            <p class="error-message">
                无法加载游戏，缺少游戏权限或权限无效。<br>
                请返回授权页面获取正确的游戏权限。
            </p>
            <a href="https://example.com/auth" class="auth-btn">
                <i class="fas fa-key"></i> 前往授权页面
            </a>
        </div>
    </div>
    
    <!-- 全屏提示 -->
    <div class="fullscreen-prompt" id="fullscreenPrompt">
        <div class="fullscreen-prompt-content">
            <button class="close-btn" id="closePromptBtn">
                <i class="fas fa-times"></i>
            </button>
            <h3 id="promptTitle">沉浸式游戏体验</h3>
            <p id="promptMessage">为了获得最佳游戏体验，建议开启全屏模式</p>
            
            <div class="fullscreen-tutorial" id="appleTutorial" style="display: none;">
                <p><strong>苹果设备全屏教程:</strong></p>
                <ol>
                    <li>点击屏幕下方的"分享"图标（方形带向上箭头）</li>
                    <li>在底部选项中找到"添加到主屏幕"</li>
                    <li>点击添加后，从主屏幕打开游戏即可获得全屏体验</li>
                </ol>
            </div>
            
            <div class="fullscreen-buttons">
                <button class="fullscreen-btn" id="fullscreenBtn">
                    <i class="fas fa-expand"></i> 开启全屏
                </button>
                <button class="fullscreen-btn apple" id="appleGuideBtn" style="display: none;">
                    <i class="fas fa-apple"></i> 查看苹果设备全屏指南
                </button>
            </div>
        </div>
    </div>
    
    <!-- 教程弹窗 -->
    <div class="tutorial-prompt" id="tutorialPrompt">
        <div class="tutorial-prompt-content">
            <button class="close-btn" id="closeTutorialBtn">
                <i class="fas fa-times"></i>
            </button>
            <h3>游戏基础教程</h3>
            
            <h4>版本特点</h4>
            <ul>
                <li>当前游戏版本为<strong>无广告纯净版</strong></li>
                <li>点击广告按钮可直接获得奖励，无需观看广告</li>
                <li>所有游戏内购项目已解锁</li>
                <li>无限金币/钻石/资源（根据游戏特性）</li>
            </ul>
            
            <h4>操作指南</h4>
            <ul>
                <li>使用键盘方向键或WASD键控制角色移动</li>
                <li>空格键或鼠标左键进行跳跃/攻击</li>
                <li>ESC键可打开游戏菜单</li>
                <li>游戏进度会自动保存</li>
            </ul>
            
            <div class="highlight">
                <h4>温馨提示</h4>
                <p>将游戏添加到主屏幕上，打开游戏更方便！苹果手机只有将游戏添加到主屏幕上才能实现存档。</p>
                <p>添加方法：点击浏览器菜单 → "添加到主屏幕"</p>
            </div>
            
            <h4>常见问题</h4>
            <ul>
                <li>游戏卡顿：尝试关闭其他后台应用</li>
                <li>无法全屏：检查浏览器设置允许全屏</li>
                <li>存档丢失：确保已添加到主屏幕（苹果设备）</li>
                <li>游戏无法运行：更新浏览器到最新版本</li>
            </ul>
        </div>
    </div>
    
    <!-- 浮动控制按钮 -->
    <div class="floating-controls" id="floatingControls">
        <button id="floatTutorialBtn" title="基础教程">
            <i class="fas fa-graduation-cap"></i>
        </button>
        <button id="floatFullscreenBtn" title="全屏">
            <i class="fas fa-expand"></i>
        </button>
        <button id="floatRefreshBtn" title="刷新">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button id="floatHomeBtn" title="返回主页">
            <i class="fas fa-home"></i>
        </button>
    </div>
    
    <footer>
        <p>© 2023 沉浸式游戏体验生成器 | 专为极致游戏体验设计</p>
    </footer>

    <script>
        // 检测苹果设备
        function isAppleDevice() {
            return /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent) && !window.MSStream;
        }
        
        // 页面加载时处理URL参数
        document.addEventListener('DOMContentLoaded', function() {
            const gameContainer = document.getElementById('gameContainer');
            const gameFrame = document.getElementById('gameFrame');
            const gameOverlay = document.getElementById('gameOverlay');
            const gameWelcomeUser = document.getElementById('gameWelcomeUser');
            const gameLoadingStatus = document.getElementById('gameLoadingStatus');
            const gameProgressBar = document.getElementById('gameProgressBar');
            const gameProgressPercent = document.getElementById('gameProgressPercent');
            const floatingControls = document.getElementById('floatingControls');
            const errorContainer = document.getElementById('errorContainer');
            const floatTutorialBtn = document.getElementById('floatTutorialBtn');
            const floatFullscreenBtn = document.getElementById('floatFullscreenBtn');
            const floatRefreshBtn = document.getElementById('floatRefreshBtn');
            const floatHomeBtn = document.getElementById('floatHomeBtn');
            const fullscreenPrompt = document.getElementById('fullscreenPrompt');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const closePromptBtn = document.getElementById('closePromptBtn');
            const tutorialPrompt = document.getElementById('tutorialPrompt');
            const closeTutorialBtn = document.getElementById('closeTutorialBtn');
            const promptTitle = document.getElementById('promptTitle');
            const promptMessage = document.getElementById('promptMessage');
            const appleTutorial = document.getElementById('appleTutorial');
            const appleGuideBtn = document.getElementById('appleGuideBtn');
            const appleTip = document.getElementById('appleTip');
            
            let isFullscreen = false;
            let fullscreenAttempts = 0;
            const maxFullscreenAttempts = 3;
            
            // 检测是否为苹果设备
            const appleDevice = isAppleDevice();
            
            // 如果是苹果设备，显示提示
            if (appleDevice) {
                appleTip.style.display = 'block';
            }
            
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const gameName = urlParams.get('gameName');
            const gameUrl = urlParams.get('gameUrl');
            const userName = urlParams.get('userName');
            const homePageUrl = urlParams.get('homePageUrl') || 'https://example.com';
            const userPermission = urlParams.get('userPermission');
            const autoFullscreen = urlParams.get('autoFullscreen') === '1';
            
            // 设置页面标题为游戏名称
            if (gameName) {
                document.title = `${gameName} - 沉浸式游戏体验`;
            }
            
            // 存储游戏参数到localStorage
            if (gameName && gameUrl && userName && userPermission) {
                const gameParams = {
                    gameUrl,
                    userName,
                    homePageUrl,
                    userPermission,
                    autoFullscreen
                };
                
                // 存储到localStorage，使用gameName作为键
                localStorage.setItem(`gameParams_${gameName}`, JSON.stringify(gameParams));
            }
            
            // 清除URL参数（仅非苹果设备清除参数）
            if (urlParams.toString()) {
                // 苹果设备：保留所有参数
                // 非苹果设备：只保留gameName参数
                if (!appleDevice) {
                    const newUrl = gameName ? `${window.location.pathname}?gameName=${encodeURIComponent(gameName)}` : window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
            }
            
            // 检查必要参数
            if (!gameName) {
                // 显示错误页面
                showError("缺少游戏名称参数");
                return;
            }
            
            // 尝试从localStorage获取参数
            const storedParams = localStorage.getItem(`gameParams_${gameName}`);
            let gameParams = {};
            
            if (storedParams) {
                gameParams = JSON.parse(storedParams);
            } else if (gameUrl && userName && userPermission) {
                // 如果URL中有参数，使用URL参数
                gameParams = {
                    gameUrl,
                    userName,
                    homePageUrl,
                    userPermission,
                    autoFullscreen
                };
            } else {
                // 显示错误页面
                showError("无法加载游戏参数");
                return;
            }
            
            // 检查权限
            if (gameParams.userPermission !== '1') {
                showError("缺少游戏权限或权限无效");
                return;
            }
            
            // 隐藏错误页面，显示游戏容器
            errorContainer.style.display = 'none';
            gameContainer.style.display = 'block';
            
            // 设置欢迎消息
            gameWelcomeUser.textContent = `欢迎, ${gameParams.userName}!`;
            gameLoadingStatus.textContent = '正在准备您的游戏体验...';
            
            // 存储主页URL
            sessionStorage.setItem('homePageUrl', gameParams.homePageUrl);
            
            // 模拟游戏加载进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 5;
                if (progress < 90) {
                    gameProgressBar.style.width = progress + '%';
                    gameProgressPercent.textContent = Math.round(progress) + '%';
                }
            }, 300);
            
            // 加载游戏
            gameFrame.src = gameParams.gameUrl;
            
            // 监听游戏加载完成
            gameFrame.addEventListener('load', function() {
                clearInterval(progressInterval);
                gameProgressBar.style.width = '100%';
                gameProgressPercent.textContent = '100%';
                gameLoadingStatus.textContent = '游戏加载完成！';
                
                setTimeout(() => {
                    gameOverlay.style.opacity = '0';
                    setTimeout(() => {
                        gameOverlay.style.display = 'none';
                    }, 500);
                    
                    // 显示浮动控制按钮
                    floatingControls.classList.add('show');
                    
                    // 自动全屏
                    if (gameParams.autoFullscreen) {
                        attemptFullscreen();
                    }
                }, 1000);
            });
            
            // 尝试进入全屏（带重试机制）
            function attemptFullscreen() {
                if (fullscreenAttempts >= maxFullscreenAttempts) {
                    // 显示全屏提示
                    setTimeout(() => {
                        showFullscreenPrompt();
                    }, 1000);
                    return;
                }
                
                enterFullscreen().then(() => {
                    // 全屏成功
                    isFullscreen = true;
                    floatFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                    // 全屏时隐藏悬浮按钮
                    floatingControls.classList.add('hide');
                }).catch(err => {
                    console.log('全屏错误: ', err);
                    fullscreenAttempts++;
                    
                    // 重试全屏
                    if (fullscreenAttempts < maxFullscreenAttempts) {
                        setTimeout(attemptFullscreen, 500);
                    } else {
                        // 显示全屏提示
                        setTimeout(() => {
                            showFullscreenPrompt();
                        }, 1000);
                    }
                });
            }
            
            // 显示全屏提示
            function showFullscreenPrompt() {
                // 如果是苹果设备，修改提示内容
                if (appleDevice) {
                    promptTitle.textContent = "苹果设备全屏提示";
                    promptMessage.textContent = "苹果设备对网页全屏有限制，请按照以下方法操作：";
                    appleTutorial.style.display = "block";
                    appleGuideBtn.style.display = "block";
                    fullscreenBtn.style.display = "none";
                } else {
                    promptTitle.textContent = "沉浸式游戏体验";
                    promptMessage.textContent = "为了获得最佳游戏体验，建议开启全屏模式";
                    appleTutorial.style.display = "none";
                    appleGuideBtn.style.display = "none";
                    fullscreenBtn.style.display = "block";
                }
                
                fullscreenPrompt.classList.add('show');
            }
            
            // 进入全屏
            function enterFullscreen() {
                return new Promise((resolve, reject) => {
                    const container = document.documentElement;
                    
                    if (container.requestFullscreen) {
                        container.requestFullscreen().then(() => {
                            resolve();
                        }).catch(err => {
                            reject(err);
                        });
                    } else if (container.mozRequestFullScreen) {
                        try {
                            container.mozRequestFullScreen();
                            resolve();
                        } catch (err) {
                            reject(err);
                        }
                    } else if (container.webkitRequestFullscreen) {
                        try {
                            container.webkitRequestFullscreen();
                            resolve();
                        } catch (err) {
                            reject(err);
                        }
                    } else if (container.msRequestFullscreen) {
                        try {
                            container.msRequestFullscreen();
                            resolve();
                        } catch (err) {
                            reject(err);
                        }
                    } else {
                        reject(new Error('全屏API不可用'));
                    }
                });
            }
            
            // 退出全屏
            function exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                isFullscreen = false;
                floatFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                // 退出全屏时显示悬浮按钮
                floatingControls.classList.remove('hide');
            }
            
            // 全屏按钮点击事件
            floatFullscreenBtn.addEventListener('click', function() {
                if (isFullscreen) {
                    exitFullscreen();
                } else {
                    enterFullscreen().then(() => {
                        isFullscreen = true;
                        floatFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                        floatingControls.classList.add('hide');
                        fullscreenPrompt.classList.remove('show');
                    }).catch(err => {
                        console.log('全屏错误: ', err);
                        showFullscreenPrompt();
                    });
                }
            });
            
            // 手动全屏按钮
            fullscreenBtn.addEventListener('click', function() {
                enterFullscreen().then(() => {
                    isFullscreen = true;
                    floatFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                    floatingControls.classList.add('hide');
                    fullscreenPrompt.classList.remove('show');
                }).catch(err => {
                    console.log('全屏错误: ', err);
                });
            });
            
            // 关闭提示按钮
            closePromptBtn.addEventListener('click', function() {
                fullscreenPrompt.classList.remove('show');
            });
            
            // 苹果设备指南按钮
            appleGuideBtn.addEventListener('click', function() {
                // 这里可以跳转到更详细的全屏指南页面
                window.open('https://example.com/apple-fullscreen-guide', '_blank');
            });
            
            // 刷新游戏
            floatRefreshBtn.addEventListener('click', function() {
                gameFrame.src = gameFrame.src;
                
                // 显示加载界面
                gameOverlay.style.display = 'flex';
                gameOverlay.style.opacity = '1';
                gameLoadingStatus.textContent = '正在重新加载游戏...';
                
                // 重置进度条
                gameProgressBar.style.width = '0%';
                gameProgressPercent.textContent = '0%';
                
                // 模拟进度
                let reloadProgress = 0;
                const reloadInterval = setInterval(() => {
                    reloadProgress += Math.random() * 10;
                    if (reloadProgress < 90) {
                        gameProgressBar.style.width = reloadProgress + '%';
                        gameProgressPercent.textContent = Math.round(reloadProgress) + '%';
                    }
                }, 200);
                
                // 游戏加载完成后清除进度模拟
                gameFrame.addEventListener('load', function() {
                    clearInterval(reloadInterval);
                    gameProgressBar.style.width = '100%';
                    gameProgressPercent.textContent = '100%';
                    gameLoadingStatus.textContent = '游戏加载完成！';
                    
                    setTimeout(() => {
                        gameOverlay.style.opacity = '0';
                        setTimeout(() => {
                            gameOverlay.style.display = 'none';
                        }, 500);
                        
                        // 自动全屏
                        if (gameParams.autoFullscreen) {
                            attemptFullscreen();
                        }
                    }, 1000);
                });
            });
            
            // 返回主页
            floatHomeBtn.addEventListener('click', function() {
                window.location.href = gameParams.homePageUrl;
            });
            
            // 教程按钮点击事件
            floatTutorialBtn.addEventListener('click', function() {
                tutorialPrompt.classList.add('show');
            });
            
            // 关闭教程按钮
            closeTutorialBtn.addEventListener('click', function() {
                tutorialPrompt.classList.remove('show');
            });
            
            // 监听全屏变化
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            
            function handleFullscreenChange() {
                isFullscreen = !!(document.fullscreenElement || 
                                 document.webkitFullscreenElement || 
                                 document.mozFullScreenElement ||
                                 document.msFullscreenElement);
                
                if (isFullscreen) {
                    floatFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                    floatingControls.classList.add('hide');
                    fullscreenPrompt.classList.remove('show');
                } else {
                    floatFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                    floatingControls.classList.remove('hide');
                }
            }
            
            // 显示错误页面
            function showError(message) {
                errorContainer.style.display = 'flex';
                gameContainer.style.display = 'none';
                
                // 更新错误消息
                document.querySelector('.error-message').innerHTML = `
                    无法加载游戏，${message}。<br>
                    请返回授权页面获取正确的游戏权限。
                `;
            }
        });
    </script>
</body>
</html>